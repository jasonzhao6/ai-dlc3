# Unit 3 — File Upload & Browsing: Design

## DynamoDB Entities (added to `FileShareTable`)

**File entity** (one per version)
- PK: `FOLDER#<folderId>`
- SK: `FILE#<fileName>#VERSION#<versionNumber>`
- Attributes: `fileId` (UUID), `fileName`, `folderId`, `folderName`, `s3Key`, `fileSize` (int), `uploadedBy`, `uploadedAt`, `versionNumber` (int)

Note: DynamoDB returns `Decimal` for numbers — convert to `int` before JSON serialization.

**File latest pointer** (for quick lookup of current version)
- PK: `FOLDER#<folderId>`
- SK: `FILE#<fileName>`
- Attributes: `fileName`, `folderId`, `latestVersion` (int), `fileSize`, `uploadedBy`, `uploadedAt`

### Access Patterns

- List files in a folder: Query PK=`FOLDER#<folderId>`, SK begins_with `FILE#` (filter out VERSION entries or use the latest pointer entries)
- Get version history for a file: Query PK=`FOLDER#<folderId>`, SK begins_with `FILE#<fileName>#VERSION#`
- Search files by name across folders: GSI-4 with GSI4PK=`FILES`, GSI4SK=`FILE#<fileName>` — then filter by user's accessible folders client-side or in Lambda

### New GSI Required

- **GSI-4**: GSI4PK / GSI4SK — for cross-folder file search by name

## S3 Design

- Bucket: `file-share-storage`
- Key pattern: `<folderId>/<fileName>/v<versionNumber>`
- Pre-signed URL for upload: generated by Lambda, max content-length 1GB
- Upload goes directly from browser to S3 (not through API Gateway/Lambda)

### Upload Flow
1. Frontend calls POST /files/upload-url with folderId, fileName, fileSize
2. Lambda validates: user has upload access to folder, fileSize ≤ 1GB
3. Lambda determines next version number (query latest pointer, increment)
4. Lambda generates S3 pre-signed PUT URL with 1GB content-length condition
5. Lambda creates/updates file metadata in DynamoDB (version entry + latest pointer)
6. Frontend uploads file directly to S3 using pre-signed URL

## API Design

All endpoints → single Lambda function (`files_handler`).

**GET /files?folderId=...&search=...&sortBy=...&sortOrder=...**
- Returns files in a folder (or search results across accessible folders)
- `folderId` — required for folder browsing, omitted for search
- `search` — optional, case-insensitive name search
- `sortBy` — `name`, `uploadedAt`, `fileSize` (default: `name`)
- `sortOrder` — `asc`, `desc` (default: `asc`)
- Filters results to only folders the user has access to

**GET /files/{folderId}/{fileName}/versions**
- Returns version history for a file

**POST /files/upload-url**
- Body: `{ "folderId": "...", "fileName": "...", "fileSize": 12345 }`
- Admin or uploader only (for that folder)
- Returns: `{ "uploadUrl": "...", "versionNumber": 3 }`

## Lambda Design

- `files_handler` Lambda: handles `/files/*` routes
- Reuses `session_util.py` from Unit 1

## React Frontend Components

- `FileList` — displays files in current folder with name, size, date, version
- `FileSearchBar` — search input, triggers cross-folder search
- `FileSortControls` — sort by name/date/size, ascending/descending
- `FileUploadButton` — shown for admin/uploader only, file picker + upload progress
- `FileVersionHistory` — modal/panel showing version list for a file

## SAM Template Updates

- Add S3 bucket `file-share-storage` for file storage
- Add GSI-4 to `FileShareTable`
- Add `FilesFunction` Lambda
- Add API Gateway routes for `/files/*`
